
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Inventario Hidromotions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Librer√≠a para leer Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root {
      --primary: #2563eb;
      --primary-soft: #eff6ff;
      --danger: #dc2626;
      --bg: #f3f4f6;
      --card: #ffffff;
      --border: #e5e7eb;
      --text: #111827;
      --muted: #6b7280;
      --comentario: #b91c1c;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(to bottom, #bfdbfe 0%, #ffffff 60%);
      color: var(--text);
    }

    .app {
      max-width: 1100px;
      margin: 0 auto;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .logo {
      height: 56px;
      width: auto;
      border-radius: 12px;
      object-fit: contain;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.25);
      background: #ffffff;
      padding: 4px 8px;
    }

    h1 {
      margin: 0;
      font-size: 1.9rem;
      text-align: center;
    }

    h2 {
      margin: 0 0 12px 0;
      font-size: 1.3rem;
    }

    .card {
      background: var(--card);
      border-radius: 18px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
      border: 1px solid var(--border);
    }

    .layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
    }

    @media (max-width: 800px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 12px;
    }

    .field {
      flex: 1 1 180px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field.small {
      flex: 0 0 120px;
    }

    label {
      font-size: 0.85rem;
      color: var(--muted);
    }

    input[type="text"],
    input[type="number"],
    select {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
      background: #ffffff;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 500;
      gap: 6px;
      transition: transform 0.1s, box-shadow 0.1s, background 0.15s;
      white-space: nowrap;
    }

    .btn.primary {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.35);
    }

    .btn.primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px rgba(37, 99, 235, 0.45);
    }

    .btn.secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn.secondary:hover {
      background: #d1d5db;
    }

    .btn.danger {
      background: #fee2e2;
      color: var(--danger);
    }

    .btn.danger:hover {
      background: #fecaca;
    }

    .btn.small {
      padding: 4px 10px;
      font-size: 0.75rem;
      box-shadow: none;
    }

    .btn-icon {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f9fafb;
      cursor: pointer;
      font-size: 0.8rem;
      margin: 0 2px;
    }

    .btn-icon:hover {
      background: #e5e7eb;
    }

    .actions-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .actions-left {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .hint {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 4px;
    }

    /* Toggle Nuevo / Existente */
    .toggle-wrapper {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .toggle-group {
      display: inline-flex;
      padding: 4px;
      background: var(--primary-soft);
      border-radius: 999px;
      border: 1px solid rgba(37, 99, 235, 0.15);
      gap: 4px;
    }

    .toggle-group input[type="radio"] {
      display: none;
    }

    .toggle-group label {
      padding: 6px 16px;
      border-radius: 999px;
      font-size: 0.85rem;
      cursor: pointer;
      color: #1f2933;
      transition: background 0.15s, color 0.15s, box-shadow 0.15s;
      user-select: none;
      white-space: nowrap;
    }

    .toggle-group input[type="radio"]:checked + label {
      background: var(--primary);
      color: #ffffff;
      box-shadow: 0 6px 14px rgba(37, 99, 235, 0.4);
    }

    /* Tabla inventario */
    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: #f9fafb;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
      border-radius: 16px;
      overflow: hidden;
    }

    thead {
      background: #e5edff;
    }

    th,
    td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
    }

    th {
      text-align: left;
      font-weight: 600;
      font-size: 0.8rem;
      color: #374151;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    tr:last-child td {
      border-bottom: none;
    }

    td.center,
    th.center {
      text-align: center;
    }

    tr:nth-child(even) td {
      background: #f3f4f6;
    }

    tr:hover td {
      background: #e5f0ff;
    }

    .no-data {
      text-align: center;
      padding: 10px;
      font-size: 0.85rem;
      color: var(--muted);
    }

    /* Importar Excel */
    .excel-import {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px dashed var(--border);
    }

    input[type="file"] {
      font-size: 0.85rem;
    }

    /* Comentarios / Retiros */
    .comentarios-list {
      list-style: none;
      padding-left: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 260px;
      overflow-y: auto;
    }

    .comentario-item {
      font-size: 0.85rem;
      color: var(--comentario);
    }

    .comentario-item span.fecha {
      font-weight: 600;
      margin-right: 4px;
    }

    .comentario-vacio {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .footer {
      margin: 12px auto 0;
      max-width: 1100px;
      font-size: 0.78rem;
      color: var(--muted);
      text-align: center;
    }

    .footer strong {
      font-weight: 600;
    }

    @media (max-width: 600px) {
      .actions-row {
        flex-direction: column;
        align-items: stretch;
      }

      .btn.primary,
      .btn.secondary {
        width: 100%;
        justify-content: center;
      }
    }

    /* ======================
       TABS
       ====================== */
    .tabs-container {
      margin-top: 8px;
    }

    .tabs-header {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .tab-btn {
      flex: 1;
      padding: 8px 10px;
      border: none;
      border-radius: 999px;
      background: #e0e7ff;
      color: #1f2937;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s, box-shadow 0.1s;
      font-size: 0.9rem;
      white-space: nowrap;
    }

    .tab-btn.tab-active {
      background: var(--primary);
      color: #ffffff;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
      transform: translateY(-1px);
    }

    .tab-content {
      display: none;
    }

    .tab-content.tab-content-active {
      display: block;
    }

    @media (max-width: 640px) {
      .tabs-header {
        flex-direction: column;
      }

      .tab-btn {
        flex: none;
        width: 100%;
      }
    }

    /* CHECKLIST */
    .section-title {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .section-subtitle {
      font-size: 0.9rem;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .small-muted {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .table-simple {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    .table-simple th,
    .table-simple td {
      border: 1px solid var(--border);
      padding: 6px 8px;
      text-align: left;
    }

    .table-simple th {
      background: #eff6ff;
    }

    .radio-badge {
      display: inline-flex;
      align-items: center;
      gap: 2px;
      margin-right: 4px;
      font-size: 0.8rem;
    }

    .radio-badge input {
      accent-color: var(--primary);
    }

    .input-number-small {
      width: 70px;
      padding: 4px 6px;
      font-size: 0.8rem;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .btn-primary-small,
    .btn-secondary-small,
    .btn-danger-small {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 0.8rem;
      cursor: pointer;
      font-weight: 600;
      margin-right: 4px;
    }

    .btn-primary-small {
      background: var(--primary);
      color: #ffffff;
    }

    .btn-secondary-small {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-danger-small {
      background: var(--danger);
      color: #ffffff;
    }

    /* HERRAMIENTAS / VEH√çCULOS */
    .estado-badge {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .estado-disponible {
      background: #dcfce7;
      color: #166534;
    }

    .estado-en-uso {
      background: #fee2e2;
      color: #991b1b;
    }

    .section-box {
      margin-top: 10px;
      padding: 10px;
      border-radius: 12px;
      background: #f9fafb;
      border: 1px solid var(--border);
    }

    .section-box h3 {
      margin-top: 0;
      font-size: 1rem;
      margin-bottom: 6px;
    }

    .section-box form {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 6px;
    }

    .section-box input[type="text"] {
      flex: 1;
      min-width: 180px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 0.85rem;
    }

    .section-box label {
      font-size: 0.8rem;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <img src="hidromotions-logo.png" alt="Logo Hidromotions" class="logo" />
      <h1>Inventario Hidromotions</h1>
    </div>

    <div class="tabs-container">
      <div class="tabs-header">
        <button class="tab-btn tab-active" data-tab="inventario">Inventario principal</button>
        <button class="tab-btn" data-tab="checklist">Check list de pedidos</button>
        <button class="tab-btn" data-tab="estado">Herramientas y veh√≠culos</button>
      </div>

      <!-- TAB 1: INVENTARIO -->
      <div id="tab-inventario" class="tab-content tab-content-active">
        <div class="layout">
          <div>
            <div class="card">
              <h2>Agregar o actualizar √≠tem</h2>

              <form id="itemForm">
                <div class="form-row">
                  <div class="toggle-wrapper">
                    <label>Tipo de registro</label>
                    <div class="toggle-group">
                      <input type="radio" id="tipoNuevo" name="tipoRegistro" value="nuevo" checked />
                      <label for="tipoNuevo">Nuevo</label>

                      <input type="radio" id="tipoExistente" name="tipoRegistro" value="existente" />
                      <label for="tipoExistente">Existente</label>
                    </div>
                    <p class="hint">
                      <strong>Nuevo:</strong> crea un √≠tem. |
                      <strong>Existente:</strong> suma a uno que ya exista (mismo nombre, marca y talla).
                    </p>
                  </div>

                  <div class="field small">
                    <label for="tipoItem">Tipo de √≠tem</label>
                    <select id="tipoItem">
                      <option value="epp" selected>EPP</option>
                      <option value="herramienta">Herramienta</option>
                      <option value="vehiculo">Veh√≠culo</option>
                    </select>
                  </div>

                  <div class="field">
                    <label for="nombreItem">Nombre del √≠tem</label>
                    <input
                      type="text"
                      id="nombreItem"
                      placeholder="Ej: Chaqueta t√©rmica"
                      required
                    />
                  </div>

                  <div class="field">
                    <label for="marcaItem">Marca</label>
                    <input
                      type="text"
                      id="marcaItem"
                      placeholder="Ej: MSA, Steelpro"
                    />
                  </div>

                  <div class="field small">
                    <label for="tallaItem">Talla</label>
                    <input
                      type="text"
                      id="tallaItem"
                      placeholder="M, L, XL, 42"
                    />
                  </div>

                  <div class="field small">
                    <label for="cantidadItem">Cantidad</label>
                    <input
                      type="number"
                      id="cantidadItem"
                      min="1"
                      step="1"
                      value="1"
                      required
                    />
                  </div>
                </div>

                <div class="form-row" style="margin-top: 8px;">
                  <div class="field">
                    <label for="comentarioItem">Comentario (para retiros)</label>
                    <input
                      type="text"
                      id="comentarioItem"
                      placeholder="Ej: Entregado a Juan P√©rez en faena"
                    />
                  </div>
                </div>

                <div class="actions-row">
                  <div class="actions-left">
                    <button type="submit" class="btn primary">
                      + Guardar en inventario
                    </button>
                    <button type="button" id="btnRetiro" class="btn secondary">
                      Registrar retiro
                    </button>
                  </div>
                  <p class="hint">
                    Los datos se guardan en este navegador (localmente). No se comparten autom√°ticamente con otras personas.
                  </p>
                </div>
              </form>

              <div class="excel-import">
                <label for="excelFile"><strong>Importar desde Excel (masivo, opcional)</strong></label>
                <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" />
                <p class="hint">
                  Usa un archivo donde la primera fila tenga las columnas
                  <strong>Nombre</strong>, <strong>Marca</strong> (opcional),
                  <strong>Talla</strong> (opcional) y <strong>Cantidad</strong>. Se sumar√° a lo que ya tengas cargado.
                </p>
              </div>
            </div>

            <div class="card">
              <h2>Inventario actual</h2>
              <div class="actions-row" style="margin-top: 4px;">
                <div class="actions-left">
                  <input
                    type="text"
                    id="buscadorInventario"
                    placeholder="Buscar por nombre, marca, talla o tipo..."
                  />
                </div>
              </div>
              <div class="table-wrapper">
                <table id="tablaInventario">
                  <thead>
                    <tr>
                      <th>√çtem</th>
                      <th>Marca</th>
                      <th>Talla</th>
                      <th>Tipo</th>
                      <th class="center">Cantidad</th>
                      <th class="center">Ajustar</th>
                      <th class="center">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                  </tbody>
                </table>
              </div>
              <p class="hint">
                Usa <strong>Editar</strong> para cambiar nombre, marca, talla o cantidad. <strong>- / +</strong> ajusta r√°pido y
                <strong>Eliminar</strong> borra el √≠tem.
              </p>
            </div>
          </div>

          <div>
            <div class="card">
              <h2>Comentarios / Retiros</h2>

              <div class="form-row" style="margin-top: 0; margin-bottom: 8px; align-items: flex-end;">
                <div class="field">
                  <label for="filtroComentarios">Filtrar por periodo</label>
                  <select id="filtroComentarios">
                    <option value="todo">Todo</option>
                    <option value="hoy">Hoy</option>
                    <option value="semana">Esta semana</option>
                    <option value="mes">Este mes</option>
                    <option value="anio">Este a√±o</option>
                  </select>
                </div>
                <div class="field">
                  <label>&nbsp;</label>
                  <button type="button" id="btnDescargarComentarios" class="btn secondary">
                    Descargar retiros
                  </button>
                </div>
              </div>

              <ul id="listaComentarios" class="comentarios-list"></ul>
              <p id="comentariosVacios" class="comentario-vacio">
                A√∫n no hay retiros registrados.
              </p>
              <p class="hint">
                Cada vez que registres un <strong>Retiro</strong>, quedar√° guardado aqu√≠ como historial (texto en rojo).
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB 2: CHECKLIST -->
      <div id="tab-checklist" class="tab-content">
        <div class="card">
          <h2 class="section-title">Check list de pedidos</h2>
          <p class="section-subtitle">
            Carga un archivo <strong>CSV</strong> con el pedido y marca si las cosas est√°n o no.
          </p>
          <p class="small-muted">
            En Excel: <strong>Archivo &gt; Guardar como &gt; CSV</strong>.<br />
            Debe tener, al menos, dos columnas: <strong>Nombre</strong> y <strong>Cantidad</strong>.
          </p>

          <input type="file" id="pedidoFile" accept=".csv" />

          <div class="table-wrapper" style="margin-top: 8px;">
            <table class="table-simple">
              <thead>
                <tr>
                  <th>√çtem</th>
                  <th>Cantidad pedida</th>
                  <th>¬øHay?</th>
                  <th>Cantidad que hay</th>
                  <th>Faltan</th>
                </tr>
              </thead>
              <tbody id="pedidoTableBody"></tbody>
            </table>
          </div>

          <div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
            <button id="btnDescargarPedido" class="btn-primary-small">
              Descargar resumen (CSV para Excel)
            </button>
            <button id="btnEliminarPedido" class="btn-danger-small">
              Eliminar listado
            </button>
            <span class="small-muted">
              Exporta el detalle de lo que hay y lo que falta, o elimina completamente el listado cargado.
            </span>
          </div>
        </div>
      </div>

      <!-- TAB 3: HERRAMIENTAS / VEHICULOS -->
      <div id="tab-estado" class="tab-content">
        <div class="card">
          <h2 class="section-title">Estado de herramientas y veh√≠culos</h2>
          <p class="section-subtitle">
            Marca si las herramientas o veh√≠culos est√°n
            <span class="estado-badge estado-disponible">Disponibles</span> o
            <span class="estado-badge estado-en-uso">En uso</span> y d√≥nde se est√°n utilizando.
          </p>

          <div class="section-box">
            <h3>Listado de herramientas</h3>
            <form id="formHerramienta">
              <label for="nombreHerramienta">Nombre herramienta:</label>
              <input type="text" id="nombreHerramienta" placeholder="Ej: Taladro percutor" required />
              <button type="submit" class="btn-primary-small">Agregar herramienta</button>
            </form>
            <div class="table-wrapper">
              <table class="table-simple">
                <thead>
                  <tr>
                    <th>Herramienta</th>
                    <th>Estado</th>
                    <th>Lugar de uso</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="tbodyHerramientas"></tbody>
              </table>
            </div>
          </div>

          <div class="section-box">
            <h3>Listado de veh√≠culos</h3>
            <form id="formVehiculo">
              <label for="nombreVehiculo">Veh√≠culo:</label>
              <input type="text" id="nombreVehiculo" placeholder="Ej: Camioneta HDM-123" required />
              <button type="submit" class="btn-primary-small">Agregar veh√≠culo</button>
            </form>
            <div class="table-wrapper">
              <table class="table-simple">
                <thead>
                  <tr>
                    <th>Veh√≠culo</th>
                    <th>Estado</th>
                    <th>Rumbo / Lugar de uso</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="tbodyVehiculos"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    <p><strong>Nota:</strong> Esta es una p√°gina <strong>no oficial</strong> de Hidromotions. Es una herramienta personal creada solo para apoyar la organizaci√≥n de inventario.</p>
  </div>

  <script>
    // --------- ESTADO INVENTARIO / COMENTARIOS ---------
    let inventario = [];
    let comentarios = [];

    function cargarDesdeStorage() {
      try {
        const data = localStorage.getItem("inventarioHidromotions");
        inventario = data ? JSON.parse(data) : [];
      } catch {
        inventario = [];
      }

      // Asegurar que todos tengan tipo (si vienen de versiones anteriores)
      inventario.forEach((item) => {
        if (!item.tipo) item.tipo = "epp";
      });

      try {
        const dataComentarios = localStorage.getItem("inventarioHidromotionsComentarios");
        comentarios = dataComentarios ? JSON.parse(dataComentarios) : [];
      } catch {
        comentarios = [];
      }
    }

    function guardarInventario() {
      localStorage.setItem("inventarioHidromotions", JSON.stringify(inventario));
    }

    function guardarComentarios() {
      localStorage.setItem("inventarioHidromotionsComentarios", JSON.stringify(comentarios));
    }

    // --------- FECHAS COMENTARIOS ---------
    function obtenerFechaComentario(c) {
      if (c.timestamp) {
        const d = new Date(c.timestamp);
        if (!isNaN(d)) return d;
      }
      const d2 = new Date(c.fecha);
      if (!isNaN(d2)) return d2;
      return null;
    }

    function esMismoDia(a, b) {
      return a.getFullYear() === b.getFullYear() &&
             a.getMonth() === b.getMonth() &&
             a.getDate() === b.getDate();
    }

    function esMismaSemana(a, b) {
      const diaSemana = b.getDay();
      const diffAlLunes = (diaSemana + 6) % 7;
      const inicioSemana = new Date(b);
      inicioSemana.setHours(0, 0, 0, 0);
      inicioSemana.setDate(b.getDate() - diffAlLunes);

      const finSemana = new Date(inicioSemana);
      finSemana.setDate(inicioSemana.getDate() + 7);

      return a >= inicioSemana && a < finSemana;
    }

    function esMismoMes(a, b) {
      return a.getFullYear() === b.getFullYear() &&
             a.getMonth() === b.getMonth();
    }

    function esMismoAnio(a, b) {
      return a.getFullYear() === b.getFullYear();
    }

    function obtenerComentariosFiltrados() {
      const filtro = document.getElementById("filtroComentarios").value;
      if (!comentarios.length) return [];

      if (filtro === "todo") return comentarios.slice();

      const ahora = new Date();

      return comentarios.filter((c) => {
        const fechaC = obtenerFechaComentario(c);
        if (!fechaC) return false;
        if (filtro === "hoy") return esMismoDia(fechaC, ahora);
        if (filtro === "semana") return esMismaSemana(fechaC, ahora);
        if (filtro === "mes") return esMismoMes(fechaC, ahora);
        if (filtro === "anio") return esMismoAnio(fechaC, ahora);
        return true;
      });
    }

    // --------- RENDER TABLA INVENTARIO ---------
    function formatearTipo(tipo) {
      if (tipo === "herramienta") return "Herramienta";
      if (tipo === "vehiculo") return "Veh√≠culo";
      return "EPP";
    }

    function renderTabla() {
      const tbody = document.querySelector("#tablaInventario tbody");
      tbody.innerHTML = "";

      let texto = "";
      const inputBuscador = document.getElementById("buscadorInventario");
      if (inputBuscador) {
        texto = inputBuscador.value.toLowerCase().trim();
      }

      const listaFiltrada = inventario.filter((item) => {
        if (!texto) return true;
        const cadena = [
          item.nombre || "",
          item.marca || "",
          item.talla || "",
          formatearTipo(item.tipo || "epp"),
        ]
          .join(" ")
          .toLowerCase();
        return cadena.includes(texto);
      });

      if (!listaFiltrada.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 7;
        td.className = "no-data";
        td.textContent = texto
          ? "No se encontraron √≠tems que coincidan con la b√∫squeda."
          : "No hay √≠tems en el inventario todav√≠a.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      listaFiltrada.forEach((item) => {
        const tr = document.createElement("tr");
        tr.dataset.id = item.id;

        const marca = item.marca || "";
        const talla = item.talla || "";

        tr.innerHTML = `
          <td>${item.nombre}</td>
          <td>${marca}</td>
          <td>${talla}</td>
          <td>${formatearTipo(item.tipo)}</td>
          <td class="center">${item.cantidad}</td>
          <td class="center">
            <button class="btn-icon" data-action="decrease">-</button>
            <button class="btn-icon" data-action="increase">+</button>
          </td>
          <td class="center">
            <button class="btn small secondary" data-action="edit">Editar</button>
            <button class="btn small danger" data-action="delete">Eliminar</button>
          </td>
        `;

        tbody.appendChild(tr);
      });
    }

    // --------- RENDER COMENTARIOS ---------
    function renderComentarios() {
      const lista = document.getElementById("listaComentarios");
      const vacio = document.getElementById("comentariosVacios");

      lista.innerHTML = "";

      const filtrados = obtenerComentariosFiltrados();

      if (!filtrados.length) {
        vacio.style.display = "block";
        return;
      }

      vacio.style.display = "none";

      filtrados.forEach((c) => {
        const li = document.createElement("li");
        li.className = "comentario-item";
        li.innerHTML = `<span class="fecha">[${c.fecha}]</span> ${c.texto}`;
        lista.appendChild(li);
      });
    }

    // --------- BUSCAR ITEM ---------
    function buscarItem(nombre, marca, talla) {
      const n = nombre.toLowerCase();
      const m = (marca || "").toLowerCase();
      const t = (talla || "").toLowerCase();

      return inventario.find(
        (i) =>
          i.nombre.toLowerCase() === n &&
          (i.marca || "").toLowerCase() === m &&
          (i.talla || "").toLowerCase() === t
      );
    }

    // --------- FORM INVENTARIO ---------
    const form = document.getElementById("itemForm");

    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const tipoRegistro = document.querySelector('input[name="tipoRegistro"]:checked').value;
      const tipoItem = document.getElementById("tipoItem").value;

      const nombreInput = document.getElementById("nombreItem");
      const marcaInput = document.getElementById("marcaItem");
      const tallaInput = document.getElementById("tallaItem");
      const cantidadInput = document.getElementById("cantidadItem");

      const nombre = nombreInput.value.trim();
      const marca = marcaInput.value.trim();
      const talla = tallaInput.value.trim();
      const cantidad = parseInt(cantidadInput.value, 10);

      if (!nombre || isNaN(cantidad) || cantidad <= 0) {
        alert("Por favor ingresa un nombre y una cantidad v√°lida.");
        return;
      }

      const existente = buscarItem(nombre, marca, talla);

      if (tipoRegistro === "nuevo") {
        const nuevoItem = {
          id: Date.now() + Math.random(),
          nombre,
          marca,
          talla,
          cantidad,
          tipo: tipoItem,
        };
        inventario.push(nuevoItem);

        if (tipoItem === "herramienta") {
          agregarHerramientaDesdeInventario(nuevoItem);
        } else if (tipoItem === "vehiculo") {
          agregarVehiculoDesdeInventario(nuevoItem);
        }

      } else {
        if (existente) {
          existente.cantidad += cantidad;
          if (!existente.tipo) existente.tipo = tipoItem;

          if (existente.tipo === "herramienta" || tipoItem === "herramienta") {
            agregarHerramientaDesdeInventario(existente);
          } else if (existente.tipo === "vehiculo" || tipoItem === "vehiculo") {
            agregarVehiculoDesdeInventario(existente);
          }
        } else {
          const nuevoItem = {
            id: Date.now() + Math.random(),
            nombre,
            marca,
            talla,
            cantidad,
            tipo: tipoItem,
          };
          inventario.push(nuevoItem);

          if (tipoItem === "herramienta") {
            agregarHerramientaDesdeInventario(nuevoItem);
          } else if (tipoItem === "vehiculo") {
            agregarVehiculoDesdeInventario(nuevoItem);
          }
        }
      }

      guardarInventario();
      renderTabla();

      cantidadInput.value = 1;
      nombreInput.value = "";
      nombreInput.focus();
    });

    // --------- REGISTRAR RETIRO ---------
    const btnRetiro = document.getElementById("btnRetiro");

    btnRetiro.addEventListener("click", () => {
      const nombreInput = document.getElementById("nombreItem");
      const marcaInput = document.getElementById("marcaItem");
      const tallaInput = document.getElementById("tallaItem");
      const cantidadInput = document.getElementById("cantidadItem");
      const comentarioInput = document.getElementById("comentarioItem");

      const nombre = nombreInput.value.trim();
      const marca = marcaInput.value.trim();
      const talla = tallaInput.value.trim();
      const cantidad = parseInt(cantidadInput.value, 10);
      const comentarioTexto = comentarioInput.value.trim();

      if (!nombre || isNaN(cantidad) || cantidad <= 0) {
        alert("Para registrar un retiro, ingresa al menos nombre y una cantidad v√°lida.");
        return;
      }

      const existente = buscarItem(nombre, marca, talla);

      if (!existente) {
        alert("No se encontr√≥ un √≠tem con ese nombre/marca/talla para retirar.");
        return;
      }

      if (cantidad > existente.cantidad) {
        const continuar = confirm(
          "Est√°s retirando m√°s de lo que hay registrado (" +
            existente.cantidad +
            "). ¬øQuieres dejarlo en 0 igualmente?"
        );
        if (!continuar) return;
        existente.cantidad = 0;
      } else {
        existente.cantidad -= cantidad;
      }

      const ahora = new Date();
      const fechaLegible = ahora.toLocaleString("es-CL");
      let detalle = `${cantidad} unid. retiradas de "${nombre}"`;

      if (marca) detalle += ` (Marca: ${marca})`;
      if (talla) detalle += ` (Talla: ${talla})`;
      if (comentarioTexto) detalle += ` - ${comentarioTexto}`;

      comentarios.unshift({
        id: Date.now() + Math.random(),
        fecha: fechaLegible,
        timestamp: ahora.toISOString(),
        texto: detalle,
      });

      if (comentarios.length > 200) {
        comentarios = comentarios.slice(0, 200);
      }

      guardarInventario();
      guardarComentarios();
      renderTabla();
      renderComentarios();

      cantidadInput.value = 1;
      comentarioInput.value = "";
    });

    // --------- BOTONES TABLA INVENTARIO ---------
    const tbodyInv = document.querySelector("#tablaInventario tbody");

    tbodyInv.addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;

      const action = btn.dataset.action;
      const tr = btn.closest("tr");
      const id = tr ? tr.dataset.id : null;
      if (!id) return;

      const item = inventario.find((i) => String(i.id) === String(id));
      if (!item) return;

      if (action === "increase") {
        item.cantidad++;
      } else if (action === "decrease") {
        if (item.cantidad > 0) item.cantidad--;
      } else if (action === "edit") {
        const nuevoNombre = prompt("Nuevo nombre del √≠tem:", item.nombre);
        if (nuevoNombre !== null && nuevoNombre.trim() !== "") {
          item.nombre = nuevoNombre.trim();
        }

        const nuevaMarca = prompt("Nueva marca:", item.marca || "");
        if (nuevaMarca !== null) {
          item.marca = nuevaMarca.trim();
        }

        const nuevaTalla = prompt("Nueva talla:", item.talla || "");
        if (nuevaTalla !== null) {
          item.talla = nuevaTalla.trim();
        }

        const nuevoTipo = prompt(
          'Tipo de √≠tem (epp, herramienta, vehiculo):',
          item.tipo || "epp"
        );
        if (nuevoTipo !== null && nuevoTipo.trim() !== "") {
          const t = nuevoTipo.trim().toLowerCase();
          if (["epp", "herramienta", "vehiculo"].includes(t)) {
            item.tipo = t;
          }
        }

        const nuevaCantidadStr = prompt(
          "Nueva cantidad:",
          String(item.cantidad)
        );
        if (
          nuevaCantidadStr !== null &&
          nuevaCantidadStr.trim() !== ""
        ) {
          const nuevaCantidad = parseInt(nuevaCantidadStr, 10);
          if (!isNaN(nuevaCantidad) && nuevaCantidad >= 0) {
            item.cantidad = nuevaCantidad;
          } else {
            alert("Cantidad no v√°lida. Se mantiene la anterior.");
          }
        }
      } else if (action === "delete") {
        if (confirm("¬øSeguro que quieres eliminar este √≠tem?")) {
          inventario = inventario.filter((i) => String(i.id) !== String(id));
        }
      }

      guardarInventario();
      renderTabla();
    });

    // --------- IMPORTAR DESDE EXCEL ---------
    const excelInput = document.getElementById("excelFile");

    excelInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (evt) {
        try {
          const data = new Uint8Array(evt.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const firstSheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[firstSheetName];

          const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

          if (!rows || rows.length < 2) {
            alert("El archivo parece estar vac√≠o.");
            return;
          }

          const headers = rows[0].map((h) =>
            (h || "").toString().toLowerCase().trim()
          );
          const idxNombre = headers.indexOf("nombre");
          const idxMarca = headers.indexOf("marca");
          const idxTalla = headers.indexOf("talla");
          const idxCantidad = headers.indexOf("cantidad");

          if (idxNombre === -1 || idxCantidad === -1) {
            alert(
              'La primera fila debe tener al menos las columnas "Nombre" y "Cantidad". Puedes agregar tambi√©n "Marca" y "Talla".'
            );
            return;
          }

          for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            if (!row || row.length === 0) continue;

            const nombre = row[idxNombre];
            const cantidadCruda = row[idxCantidad];

            if (!nombre) continue;

            const nombreStr = nombre.toString().trim();
            if (!nombreStr) continue;

            const marcaStr =
              idxMarca !== -1 && row[idxMarca] != null
                ? row[idxMarca].toString().trim()
                : "";
            const tallaStr =
              idxTalla !== -1 && row[idxTalla] != null
                ? row[idxTalla].toString().trim()
                : "";

            const cantidad = parseInt(cantidadCruda, 10) || 0;
            if (cantidad <= 0) continue;

            const existente = buscarItem(nombreStr, marcaStr, tallaStr);

            if (existente) {
              existente.cantidad += cantidad;
            } else {
              inventario.push({
                id: Date.now() + i + Math.random(),
                nombre: nombreStr,
                marca: marcaStr,
                talla: tallaStr,
                cantidad,
                tipo: "epp", // por defecto, lo que entra por Excel es EPP
              });
            }
          }

          guardarInventario();
          renderTabla();
          alert("Importaci√≥n desde Excel completada üò∫");
        } catch (err) {
          console.error(err);
          alert("Ocurri√≥ un problema al leer el Excel.");
        }
      };

      reader.readAsArrayBuffer(file);
    });

    // --------- DESCARGAR COMENTARIOS ---------
    const btnDescargarComentarios = document.getElementById("btnDescargarComentarios");

    btnDescargarComentarios.addEventListener("click", () => {
      const filtrados = obtenerComentariosFiltrados();
      if (!filtrados.length) {
        alert("No hay retiros para descargar con el filtro actual.");
        return;
      }

      let contenido = "Fecha,Detalle\n";
      filtrados.forEach((c) => {
        const fecha = (c.fecha || "").replace(/"/g, '""');
        const texto = (c.texto || "").replace(/"/g, '""');
        contenido += `"${fecha}","${texto}"\n`;
      });

      const blob = new Blob([contenido], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const hoyISO = new Date().toISOString().slice(0, 10);
      a.href = url;
      a.download = `retiros_${hoyISO}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    const filtroComentariosSelect = document.getElementById("filtroComentarios");
    filtroComentariosSelect.addEventListener("change", renderComentarios);

    // --------- TABS ---------
    const tabButtons = document.querySelectorAll(".tab-btn");

    tabButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const target = btn.getAttribute("data-tab");

        tabButtons.forEach((b) => b.classList.remove("tab-active"));
        btn.classList.add("tab-active");

        document.querySelectorAll(".tab-content").forEach((c) => {
          c.classList.remove("tab-content-active");
        });

        const content = document.getElementById("tab-" + target);
        if (content) content.classList.add("tab-content-active");
      });
    });

    // --------- CHECKLIST PEDIDOS ---------
    let pedidoActual = [];
    const pedidoFileInput = document.getElementById("pedidoFile");
    const pedidoTbody = document.getElementById("pedidoTableBody");
    const btnDescargarPedido = document.getElementById("btnDescargarPedido");
    const btnEliminarPedido = document.getElementById("btnEliminarPedido");

    function parsearPedidoCSV(texto) {
      pedidoActual = [];
      pedidoTbody.innerHTML = "";

      const lineas = texto
        .split(/\r?\n/)
        .map((l) => l.trim())
        .filter((l) => l !== "");

      if (!lineas.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 5;
        td.className = "no-data";
        td.textContent = "El archivo est√° vac√≠o.";
        tr.appendChild(td);
        pedidoTbody.appendChild(tr);
        return;
      }

      lineas.forEach((linea, index) => {
        if (index === 0 && /nombre/i.test(linea)) {
          // tratar primera l√≠nea como encabezado si habla de "nombre"
          return;
        }

        let partes = linea.split(";");
        if (partes.length === 1) partes = linea.split(",");
        if (partes.length < 2) return;

        const nombre = partes[0].trim();
        const cantidadStr = partes[1].trim().replace(",", ".");
        const cantidad = Number(cantidadStr);

        if (!nombre || isNaN(cantidad)) return;

        pedidoActual.push({
          nombre,
          cantidadPedida: cantidad,
          estado: null,
          cantidadHay: 0,
          cantidadFalta: cantidad,
        });
      });

      renderPedidoTabla();
    }

    function renderPedidoTabla() {
      pedidoTbody.innerHTML = "";

      if (!pedidoActual.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 5;
        td.className = "no-data";
        td.textContent = "No se carg√≥ ning√∫n √≠tem. Revisa el archivo CSV.";
        tr.appendChild(td);
        pedidoTbody.appendChild(tr);
        return;
      }

      pedidoActual.forEach((item, index) => {
        const tr = document.createElement("tr");

        const tdNombre = document.createElement("td");
        tdNombre.textContent = item.nombre;

        const tdCantPedida = document.createElement("td");
        tdCantPedida.textContent = item.cantidadPedida;

        const tdEstado = document.createElement("td");
        const labelOk = document.createElement("label");
        labelOk.className = "radio-badge";
        const radioOk = document.createElement("input");
        radioOk.type = "radio";
        radioOk.name = "estado-" + index;
        radioOk.value = "ok";
        if (item.estado === "ok") radioOk.checked = true;
        labelOk.appendChild(radioOk);
        labelOk.append("‚úì");

        const labelFalta = document.createElement("label");
        labelFalta.className = "radio-badge";
        const radioFalta = document.createElement("input");
        radioFalta.type = "radio";
        radioFalta.name = "estado-" + index;
        radioFalta.value = "falta";
        if (item.estado === "falta") radioFalta.checked = true;
        labelFalta.appendChild(radioFalta);
        labelFalta.append("X");

        tdEstado.appendChild(labelOk);
        tdEstado.appendChild(labelFalta);

        const tdHay = document.createElement("td");
        const inputHay = document.createElement("input");
        inputHay.type = "number";
        inputHay.min = "0";
        inputHay.className = "input-number-small";
        inputHay.value =
          typeof item.cantidadHay === "number" ? item.cantidadHay : "";
        tdHay.appendChild(inputHay);

        const tdFaltan = document.createElement("td");
        const inputFaltan = document.createElement("input");
        inputFaltan.type = "number";
        inputFaltan.readOnly = true;
        inputFaltan.className = "input-number-small";
        inputFaltan.value =
          typeof item.cantidadFalta === "number"
            ? item.cantidadFalta
            : item.cantidadPedida;
        tdFaltan.appendChild(inputFaltan);

        tr.appendChild(tdNombre);
        tr.appendChild(tdCantPedida);
        tr.appendChild(tdEstado);
        tr.appendChild(tdHay);
        tr.appendChild(tdFaltan);

        radioOk.addEventListener("change", () =>
          cambiarEstadoPedido(index, "ok", inputHay, inputFaltan)
        );
        radioFalta.addEventListener("change", () =>
          cambiarEstadoPedido(index, "falta", inputHay, inputFaltan)
        );
        inputHay.addEventListener("input", () =>
          cambiarCantidadHay(index, inputHay, inputFaltan)
        );

        pedidoTbody.appendChild(tr);
      });
    }

    function cambiarEstadoPedido(index, estado, inputHay, inputFaltan) {
      const item = pedidoActual[index];
      if (!item) return;
      item.estado = estado;

      if (estado === "ok") {
        item.cantidadHay = item.cantidadPedida;
        item.cantidadFalta = 0;
        inputHay.value = item.cantidadPedida;
        inputHay.readOnly = true;
        inputFaltan.value = 0;
      } else {
        inputHay.readOnly = false;
        const hay = Number(inputHay.value || 0);
        const faltan = Math.max(0, item.cantidadPedida - hay);
        item.cantidadHay = hay;
        item.cantidadFalta = faltan;
        inputFaltan.value = faltan;
      }
    }

    function cambiarCantidadHay(index, inputHay, inputFaltan) {
      const item = pedidoActual[index];
      if (!item) return;
      let hay = Number(inputHay.value || 0);
      if (isNaN(hay) || hay < 0) hay = 0;
      item.cantidadHay = hay;
      const faltan = Math.max(0, item.cantidadPedida - hay);
      item.cantidadFalta = faltan;
      inputFaltan.value = faltan;
    }

    function descargarResumenPedido() {
      if (!pedidoActual.length) {
        alert("No hay ning√∫n pedido cargado.");
        return;
      }

      let csv = "Item;Cantidad pedida;Estado;Cantidad que hay;Faltan\n";

      pedidoActual.forEach((item) => {
        const estadoTexto =
          item.estado === "ok"
            ? "Hay todo"
            : item.estado === "falta"
            ? "Faltan"
            : "";
        const hay =
          typeof item.cantidadHay === "number" ? item.cantidadHay : "";
        const faltan =
          typeof item.cantidadFalta === "number"
            ? item.cantidadFalta
            : Math.max(0, item.cantidadPedida - (hay || 0));

        csv += `"${(item.nombre || "").replace(/"/g, '""')}";${item.cantidadPedida};${estadoTexto};${hay};${faltan}\n`;
      });

      const blob = new Blob([csv], {
        type: "text/csv;charset=utf-8;",
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "resumen_pedido.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    if (pedidoFileInput) {
      pedidoFileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (ev) {
          const texto = ev.target.result;
          parsearPedidoCSV(texto);
        };
        reader.readAsText(file, "UTF-8");
      });
    }

    if (btnDescargarPedido) {
      btnDescargarPedido.addEventListener("click", descargarResumenPedido);
    }

    if (btnEliminarPedido) {
      btnEliminarPedido.addEventListener("click", () => {
        const confirmar = confirm("¬øSeguro que quieres eliminar todo el listado del check list?");
        if (!confirmar) return;
        pedidoActual = [];
        renderPedidoTabla();
      });
    }

    // --------- HERRAMIENTAS Y VEH√çCULOS ---------
    let herramientas = [];
    let vehiculos = [];

    const tbodyHerramientas = document.getElementById("tbodyHerramientas");
    const tbodyVehiculos = document.getElementById("tbodyVehiculos");
    const formHerramienta = document.getElementById("formHerramienta");
    const formVehiculo = document.getElementById("formVehiculo");
    const inputHerramienta = document.getElementById("nombreHerramienta");
    const inputVehiculo = document.getElementById("nombreVehiculo");

    const STORAGE_HERR = "hidro_herramientas";
    const STORAGE_VEH = "hidro_vehiculos";

    function cargarListadosHV() {
      try {
        const h = localStorage.getItem(STORAGE_HERR);
        const v = localStorage.getItem(STORAGE_VEH);
        herramientas = h ? JSON.parse(h) : [];
        vehiculos = v ? JSON.parse(v) : [];
      } catch {
        herramientas = [];
        vehiculos = [];
      }
      renderHerramientas();
      renderVehiculos();
    }

    function guardarListadosHV() {
      try {
        localStorage.setItem(STORAGE_HERR, JSON.stringify(herramientas));
        localStorage.setItem(STORAGE_VEH, JSON.stringify(vehiculos));
      } catch (e) {
        console.warn("No se pudo guardar herramientas/veh√≠culos en localStorage", e);
      }
    }

    function agregarHerramientaDesdeInventario(item) {
      if (!item || !item.nombre) return;
      const nombre = item.nombre.toLowerCase();
      const existe = herramientas.find((h) => h.nombre.toLowerCase() === nombre);
      if (existe) return;
      herramientas.push({ nombre: item.nombre, estado: "disponible", lugar: "" });
      guardarListadosHV();
      renderHerramientas();
    }

    function agregarVehiculoDesdeInventario(item) {
      if (!item || !item.nombre) return;
      const nombre = item.nombre.toLowerCase();
      const existe = vehiculos.find((v) => v.nombre.toLowerCase() === nombre);
      if (existe) return;
      vehiculos.push({ nombre: item.nombre, estado: "disponible", lugar: "" });
      guardarListadosHV();
      renderVehiculos();
    }

    function renderHerramientas() {
      if (!tbodyHerramientas) return;
      tbodyHerramientas.innerHTML = "";
      if (!herramientas.length) return;

      herramientas.forEach((h, index) => {
        const tr = document.createElement("tr");

        const tdNombre = document.createElement("td");
        tdNombre.textContent = h.nombre;

        const tdEstado = document.createElement("td");
        const spanEstado = document.createElement("span");
        spanEstado.className =
          "estado-badge " +
          (h.estado === "en-uso" ? "estado-en-uso" : "estado-disponible");
        spanEstado.textContent =
          h.estado === "en-uso" ? "En uso" : "Disponible";
        tdEstado.appendChild(spanEstado);

        const tdLugar = document.createElement("td");
        tdLugar.textContent = h.lugar || "";

        const tdAcciones = document.createElement("td");

        const btnEnUso = document.createElement("button");
        btnEnUso.className = "btn-secondary-small";
        btnEnUso.textContent = 'Marcar "En uso"';
        btnEnUso.addEventListener("click", () =>
          marcarHerramientaEnUso(index)
        );

        const btnDisponible = document.createElement("button");
        btnDisponible.className = "btn-primary-small";
        btnDisponible.textContent = 'Marcar "Disponible"';
        btnDisponible.addEventListener("click", () =>
          marcarHerramientaDisponible(index)
        );

        const btnEliminar = document.createElement("button");
        btnEliminar.className = "btn-danger-small";
        btnEliminar.textContent = "Eliminar";
        btnEliminar.addEventListener("click", () =>
          eliminarHerramienta(index)
        );

        tdAcciones.appendChild(btnEnUso);
        tdAcciones.appendChild(btnDisponible);
        tdAcciones.appendChild(btnEliminar);

        tr.appendChild(tdNombre);
        tr.appendChild(tdEstado);
        tr.appendChild(tdLugar);
        tr.appendChild(tdAcciones);

        tbodyHerramientas.appendChild(tr);
      });
    }

    function renderVehiculos() {
      if (!tbodyVehiculos) return;
      tbodyVehiculos.innerHTML = "";
      if (!vehiculos.length) return;

      vehiculos.forEach((v, index) => {
        const tr = document.createElement("tr");

        const tdNombre = document.createElement("td");
        tdNombre.textContent = v.nombre;

        const tdEstado = document.createElement("td");
        const spanEstado = document.createElement("span");
        spanEstado.className =
          "estado-badge " +
          (v.estado === "en-uso" ? "estado-en-uso" : "estado-disponible");
        spanEstado.textContent =
          v.estado === "en-uso" ? "En uso" : "Disponible";
        tdEstado.appendChild(spanEstado);

        const tdLugar = document.createElement("td");
        tdLugar.textContent = v.lugar || "";

        const tdAcciones = document.createElement("td");

        const btnEnUso = document.createElement("button");
        btnEnUso.className = "btn-secondary-small";
        btnEnUso.textContent = 'Marcar "En uso"';
        btnEnUso.addEventListener("click", () =>
          marcarVehiculoEnUso(index)
        );

        const btnDisponible = document.createElement("button");
        btnDisponible.className = "btn-primary-small";
        btnDisponible.textContent = 'Marcar "Disponible"';
        btnDisponible.addEventListener("click", () =>
          marcarVehiculoDisponible(index)
        );

        const btnEliminar = document.createElement("button");
        btnEliminar.className = "btn-danger-small";
        btnEliminar.textContent = "Eliminar";
        btnEliminar.addEventListener("click", () =>
          eliminarVehiculo(index)
        );

        tdAcciones.appendChild(btnEnUso);
        tdAcciones.appendChild(btnDisponible);
        tdAcciones.appendChild(btnEliminar);

        tr.appendChild(tdNombre);
        tr.appendChild(tdEstado);
        tr.appendChild(tdLugar);
        tr.appendChild(tdAcciones);

        tbodyVehiculos.appendChild(tr);
      });
    }

    function marcarHerramientaEnUso(index) {
      const h = herramientas[index];
      if (!h) return;
      const lugar = prompt(
        "¬øD√≥nde se est√° usando esta herramienta?\n(Ej: Bodega, Taller, Mina Gold Fields, etc.)",
        h.lugar || ""
      );
      if (lugar === null) return;
      h.estado = "en-uso";
      h.lugar = lugar.trim();
      guardarListadosHV();
      renderHerramientas();
    }

    function marcarHerramientaDisponible(index) {
      const h = herramientas[index];
      if (!h) return;
      h.estado = "disponible";
      h.lugar = "";
      guardarListadosHV();
      renderHerramientas();
    }

    function eliminarHerramienta(index) {
      if (!confirm("¬øEliminar esta herramienta del listado?")) return;
      herramientas.splice(index, 1);
      guardarListadosHV();
      renderHerramientas();
    }

    function marcarVehiculoEnUso(index) {
      const v = vehiculos[index];
      if (!v) return;
      const lugar = prompt(
        "¬øD√≥nde se est√° usando este veh√≠culo?\n(Ej: Ruta a Gold Fields, Taller, En mantenci√≥n, etc.)",
        v.lugar || ""
      );
      if (lugar === null) return;
      v.estado = "en-uso";
      v.lugar = lugar.trim();
      guardarListadosHV();
      renderVehiculos();
    }

    function marcarVehiculoDisponible(index) {
      const v = vehiculos[index];
      if (!v) return;
      v.estado = "disponible";
      v.lugar = "";
      guardarListadosHV();
      renderVehiculos();
    }

    function eliminarVehiculo(index) {
      if (!confirm("¬øEliminar este veh√≠culo del listado?")) return;
      vehiculos.splice(index, 1);
      guardarListadosHV();
      renderVehiculos();
    }

    if (formHerramienta && inputHerramienta) {
      formHerramienta.addEventListener("submit", (e) => {
        e.preventDefault();
        const nombre = inputHerramienta.value.trim();
        if (!nombre) return;
        herramientas.push({
          nombre,
          estado: "disponible",
          lugar: "",
        });
        inputHerramienta.value = "";
        guardarListadosHV();
        renderHerramientas();
      });
    }

    if (formVehiculo && inputVehiculo) {
      formVehiculo.addEventListener("submit", (e) => {
        e.preventDefault();
        const nombre = inputVehiculo.value.trim();
        if (!nombre) return;
        vehiculos.push({
          nombre,
          estado: "disponible",
          lugar: "",
        });
        inputVehiculo.value = "";
        guardarListadosHV();
        renderVehiculos();
      });
    }

    // --------- BUSCADOR INVENTARIO ---------
    const buscadorInventario = document.getElementById("buscadorInventario");
    if (buscadorInventario) {
      buscadorInventario.addEventListener("input", renderTabla);
    }

    // --------- INICIO ---------
    cargarDesdeStorage();
    renderTabla();
    renderComentarios();
    cargarListadosHV();
  </script>
</body>
</html>
