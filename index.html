
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Inventario Hidromotions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Librer칤a para leer Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root {
      --primary: #2563eb;
      --primary-soft: #eff6ff;
      --danger: #dc2626;
      --bg: #f3f4f6;
      --card: #ffffff;
      --border: #e5e7eb;
      --text: #111827;
      --muted: #6b7280;
      --comentario: #b91c1c;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(to bottom, #bfdbfe 0%, #ffffff 60%);
      color: var(--text);
    }

    .app {
      max-width: 1100px;
      margin: 0 auto;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .logo {
      height: 56px;
      width: auto;
      border-radius: 12px;
      object-fit: contain;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.25);
      background: #ffffff;
      padding: 4px 8px;
    }

    h1 {
      margin: 0;
      font-size: 1.9rem;
      text-align: center;
    }

    h2 {
      margin: 0 0 12px 0;
      font-size: 1.3rem;
    }

    .card {
      background: var(--card);
      border-radius: 18px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
      border: 1px solid var(--border);
    }

    .layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
    }

    @media (max-width: 800px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 12px;
    }

    .field {
      flex: 1 1 180px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field.small {
      flex: 0 0 120px;
    }

    label {
      font-size: 0.85rem;
      color: var(--muted);
    }

    input[type="text"],
    input[type="number"] {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    input[type="text"]:focus,
    input[type="number"]:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 500;
      gap: 6px;
      transition: transform 0.1s, box-shadow 0.1s, background 0.15s;
      white-space: nowrap;
    }

    .btn.primary {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.35);
    }

    .btn.primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px rgba(37, 99, 235, 0.45);
    }

    .btn.secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn.secondary:hover {
      background: #d1d5db;
    }

    .btn.danger {
      background: #fee2e2;
      color: var(--danger);
    }

    .btn.danger:hover {
      background: #fecaca;
    }

    .btn.small {
      padding: 4px 10px;
      font-size: 0.75rem;
      box-shadow: none;
    }

    .btn-icon {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f9fafb;
      cursor: pointer;
      font-size: 0.8rem;
      margin: 0 2px;
    }

    .btn-icon:hover {
      background: #e5e7eb;
    }

    .actions-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .actions-left {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .hint {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 4px;
    }

    /* Toggle Nuevo / Existente */
    .toggle-wrapper {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .toggle-group {
      display: inline-flex;
      padding: 4px;
      background: var(--primary-soft);
      border-radius: 999px;
      border: 1px solid rgba(37, 99, 235, 0.15);
      gap: 4px;
    }

    .toggle-group input[type="radio"] {
      display: none;
    }

    .toggle-group label {
      padding: 6px 16px;
      border-radius: 999px;
      font-size: 0.85rem;
      cursor: pointer;
      color: #1f2933;
      transition: background 0.15s, color 0.15s, box-shadow 0.15s;
      user-select: none;
      white-space: nowrap;
    }

    .toggle-group input[type="radio"]:checked + label {
      background: var(--primary);
      color: #ffffff;
      box-shadow: 0 6px 14px rgba(37, 99, 235, 0.4);
    }

    /* Tabla inventario */
    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: #f9fafb;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
      border-radius: 16px;
      overflow: hidden;
    }

    thead {
      background: #e5edff;
    }

    th,
    td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
    }

    th {
      text-align: left;
      font-weight: 600;
      font-size: 0.8rem;
      color: #374151;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    tr:last-child td {
      border-bottom: none;
    }

    td.center,
    th.center {
      text-align: center;
    }

    tr:nth-child(even) td {
      background: #f3f4f6;
    }

    tr:hover td {
      background: #e5f0ff;
    }

    .no-data {
      text-align: center;
      padding: 10px;
      font-size: 0.85rem;
      color: var(--muted);
    }

    /* Importar Excel */
    .excel-import {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px dashed var(--border);
    }

    input[type="file"] {
      font-size: 0.85rem;
    }

    /* Comentarios / Retiros */
    .comentarios-list {
      list-style: none;
      padding-left: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 260px;
      overflow-y: auto;
    }

    .comentario-item {
      font-size: 0.85rem;
      color: var(--comentario);
    }

    .comentario-item span.fecha {
      font-weight: 600;
      margin-right: 4px;
    }

    .comentario-vacio {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .footer {
      margin: 12px auto 0;
      max-width: 1100px;
      font-size: 0.78rem;
      color: var(--muted);
      text-align: center;
    }

    .footer strong {
      font-weight: 600;
    }

    @media (max-width: 600px) {
      .actions-row {
        flex-direction: column;
        align-items: stretch;
      }

      .btn.primary,
      .btn.secondary {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <!-- Ajusta la ruta del logo seg칰n el nombre del archivo en tu repositorio -->
      <img src="hidromotions-logo.png" alt="Logo Hidromotions" class="logo" />
      <h1>Inventario Hidromotions</h1>
    </div>

    <div class="layout">
      <div>
        <!-- Formulario para agregar / actualizar 칤tems -->
        <div class="card">
          <h2>Agregar o actualizar 칤tem</h2>

          <form id="itemForm">
            <div class="form-row">
              <div class="toggle-wrapper">
                <label>Tipo de registro</label>
                <div class="toggle-group">
                  <input type="radio" id="tipoNuevo" name="tipoRegistro" value="nuevo" checked />
                  <label for="tipoNuevo">Nuevo</label>

                  <input type="radio" id="tipoExistente" name="tipoRegistro" value="existente" />
                  <label for="tipoExistente">Existente</label>
                </div>
                <p class="hint">
                  <strong>Nuevo:</strong> crea un 칤tem. |
                  <strong>Existente:</strong> suma a uno que ya exista (mismo nombre, marca y talla).
                </p>
              </div>

              <div class="field">
                <label for="nombreItem">Nombre del 칤tem</label>
                <input
                  type="text"
                  id="nombreItem"
                  placeholder="Ej: Chaqueta t칠rmica"
                  required
                />
              </div>

              <div class="field">
                <label for="marcaItem">Marca</label>
                <input
                  type="text"
                  id="marcaItem"
                  placeholder="Ej: MSA, Steelpro"
                />
              </div>

              <div class="field small">
                <label for="tallaItem">Talla</label>
                <input
                  type="text"
                  id="tallaItem"
                  placeholder="M, L, XL, 42"
                />
              </div>

              <div class="field small">
                <label for="cantidadItem">Cantidad</label>
                <input
                  type="number"
                  id="cantidadItem"
                  min="1"
                  step="1"
                  value="1"
                  required
                />
              </div>
            </div>

            <div class="form-row" style="margin-top: 8px;">
              <div class="field">
                <label for="comentarioItem">Comentario (para retiros)</label>
                <input
                  type="text"
                  id="comentarioItem"
                  placeholder="Ej: Entregado a Juan P칠rez en faena"
                />
              </div>
            </div>

            <div class="actions-row">
              <div class="actions-left">
                <button type="submit" class="btn primary">
                  + Guardar en inventario
                </button>
                <button type="button" id="btnRetiro" class="btn secondary">
                  Registrar retiro
                </button>
              </div>
              <p class="hint">
                Los datos se guardan en este navegador (localmente). No se comparten autom치ticamente con otras personas.
              </p>
            </div>
          </form>

          <!-- Importar Excel -->
          <div class="excel-import">
            <label for="excelFile"><strong>Importar desde Excel (masivo, opcional)</strong></label>
            <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" />
            <p class="hint">
              Usa un archivo donde la primera fila tenga las columnas
              <strong>Nombre</strong>, <strong>Marca</strong> (opcional),
              <strong>Talla</strong> (opcional) y <strong>Cantidad</strong>. Se sumar치 a lo que ya tengas cargado.
            </p>
          </div>
        </div>

        <!-- Tabla inventario -->
        <div class="card">
          <h2>Inventario actual</h2>
          <div class="table-wrapper">
            <table id="tablaInventario">
              <thead>
                <tr>
                  <th>칈tem</th>
                  <th>Marca</th>
                  <th>Talla</th>
                  <th class="center">Cantidad</th>
                  <th class="center">Ajustar</th>
                  <th class="center">Acciones</th>
                </tr>
              </thead>
              <tbody>
                <!-- Filas din치micas -->
              </tbody>
            </table>
          </div>
          <p class="hint">
            Usa <strong>Editar</strong> para cambiar nombre, marca, talla o cantidad. <strong>- / +</strong> ajusta r치pido y
            <strong>Eliminar</strong> borra el 칤tem.
          </p>
        </div>
      </div>

      <!-- Comentarios / Retiros -->
      <div>
        <div class="card">
          <h2>Comentarios / Retiros</h2>
          <ul id="listaComentarios" class="comentarios-list">
            <!-- Comentarios din치micos -->
          </ul>
          <p id="comentariosVacios" class="comentario-vacio">
            A칰n no hay retiros registrados.
          </p>
          <p class="hint">
            Cada vez que registres un <strong>Retiro</strong>, quedar치 guardado aqu칤 como historial (texto en rojo).
          </p>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    <p><strong>Nota:</strong> Esta es una p치gina <strong>no oficial</strong> de Hidromotions. Es una herramienta personal creada solo para apoyar la organizaci칩n de inventario.</p>
  </div>

  <script>
    // -----------------------------
    // Estado y almacenamiento
    // -----------------------------
    let inventario = [];
    let comentarios = [];

    function cargarDesdeStorage() {
      try {
        const data = localStorage.getItem("inventarioHidromotions");
        inventario = data ? JSON.parse(data) : [];
      } catch (e) {
        inventario = [];
      }

      try {
        const dataComentarios = localStorage.getItem("inventarioHidromotionsComentarios");
        comentarios = dataComentarios ? JSON.parse(dataComentarios) : [];
      } catch (e) {
        comentarios = [];
      }
    }

    function guardarInventario() {
      localStorage.setItem("inventarioHidromotions", JSON.stringify(inventario));
    }

    function guardarComentarios() {
      localStorage.setItem("inventarioHidromotionsComentarios", JSON.stringify(comentarios));
    }

    // -----------------------------
    // Render tabla
    // -----------------------------
    function renderTabla() {
      const tbody = document.querySelector("#tablaInventario tbody");
      tbody.innerHTML = "";

      if (!inventario.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 6;
        td.className = "no-data";
        td.textContent = "No hay 칤tems en el inventario todav칤a.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      inventario.forEach((item) => {
        const tr = document.createElement("tr");
        tr.dataset.id = item.id;

        const marca = item.marca || "";
        const talla = item.talla || "";

        tr.innerHTML = `
          <td>${item.nombre}</td>
          <td>${marca}</td>
          <td>${talla}</td>
          <td class="center">${item.cantidad}</td>
          <td class="center">
            <button class="btn-icon" data-action="decrease">-</button>
            <button class="btn-icon" data-action="increase">+</button>
          </td>
          <td class="center">
            <button class="btn small secondary" data-action="edit">Editar</button>
            <button class="btn small danger" data-action="delete">Eliminar</button>
          </td>
        `;

        tbody.appendChild(tr);
      });
    }

    // -----------------------------
    // Render comentarios
    // -----------------------------
    function renderComentarios() {
      const lista = document.getElementById("listaComentarios");
      const vacio = document.getElementById("comentariosVacios");

      lista.innerHTML = "";

      if (!comentarios.length) {
        vacio.style.display = "block";
        return;
      }

      vacio.style.display = "none";

      comentarios.forEach((c) => {
        const li = document.createElement("li");
        li.className = "comentario-item";
        li.innerHTML = `<span class="fecha">[${c.fecha}]</span> ${c.texto}`;
        lista.appendChild(li);
      });
    }

    // -----------------------------
    // Utilidad: buscar 칤tem por nombre+marca+talla
    // -----------------------------
    function buscarItem(nombre, marca, talla) {
      const n = nombre.toLowerCase();
      const m = (marca || "").toLowerCase();
      const t = (talla || "").toLowerCase();

      return inventario.find(
        (i) =>
          i.nombre.toLowerCase() === n &&
          (i.marca || "").toLowerCase() === m &&
          (i.talla || "").toLowerCase() === t
      );
    }

    // -----------------------------
    // Agregar / actualizar 칤tems
    // -----------------------------
    const form = document.getElementById("itemForm");

    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const tipo = document.querySelector('input[name="tipoRegistro"]:checked').value;
      const nombreInput = document.getElementById("nombreItem");
      const marcaInput = document.getElementById("marcaItem");
      const tallaInput = document.getElementById("tallaItem");
      const cantidadInput = document.getElementById("cantidadItem");

      const nombre = nombreInput.value.trim();
      const marca = marcaInput.value.trim();
      const talla = tallaInput.value.trim();
      const cantidad = parseInt(cantidadInput.value, 10);

      if (!nombre || isNaN(cantidad) || cantidad <= 0) {
        alert("Por favor ingresa un nombre y una cantidad v치lida.");
        return;
      }

      const existente = buscarItem(nombre, marca, talla);

      if (tipo === "nuevo") {
        // Siempre crea un 칤tem nuevo
        inventario.push({
          id: Date.now() + Math.random(),
          nombre,
          marca,
          talla,
          cantidad,
        });
      } else if (tipo === "existente") {
        if (existente) {
          existente.cantidad += cantidad;
        } else {
          // Si marca existente pero no se encontr칩, lo creamos igual para no perder el dato
          inventario.push({
            id: Date.now() + Math.random(),
            nombre,
            marca,
            talla,
            cantidad,
          });
        }
      }

      guardarInventario();
      renderTabla();

      // Limpiar un poco el formulario (menos marca/talla por si repite)
      cantidadInput.value = 1;
      nombreInput.value = "";
      nombreInput.focus();
    });

    // -----------------------------
    // Registrar retiro
    // -----------------------------
    const btnRetiro = document.getElementById("btnRetiro");

    btnRetiro.addEventListener("click", () => {
      const nombreInput = document.getElementById("nombreItem");
      const marcaInput = document.getElementById("marcaItem");
      const tallaInput = document.getElementById("tallaItem");
      const cantidadInput = document.getElementById("cantidadItem");
      const comentarioInput = document.getElementById("comentarioItem");

      const nombre = nombreInput.value.trim();
      const marca = marcaInput.value.trim();
      const talla = tallaInput.value.trim();
      const cantidad = parseInt(cantidadInput.value, 10);
      const comentarioTexto = comentarioInput.value.trim();

      if (!nombre || isNaN(cantidad) || cantidad <= 0) {
        alert("Para registrar un retiro, ingresa al menos nombre y una cantidad v치lida.");
        return;
      }

      const existente = buscarItem(nombre, marca, talla);

      if (!existente) {
        alert("No se encontr칩 un 칤tem con ese nombre/marca/talla para retirar.");
        return;
      }

      if (cantidad > existente.cantidad) {
        const continuar = confirm(
          "Est치s retirando m치s de lo que hay registrado (" +
            existente.cantidad +
            "). 쯈uieres dejarlo en 0 igualmente?"
        );
        if (!continuar) return;
        existente.cantidad = 0;
      } else {
        existente.cantidad -= cantidad;
      }

      const fecha = new Date().toLocaleString("es-CL");
      let detalle = `${cantidad} unid. retiradas de "${nombre}"`;

      if (marca) detalle += ` (Marca: ${marca})`;
      if (talla) detalle += ` (Talla: ${talla})`;
      if (comentarioTexto) detalle += ` - ${comentarioTexto}`;

      comentarios.unshift({
        id: Date.now() + Math.random(),
        fecha,
        texto: detalle,
      });

      // Limitar historial a 200 por si acaso
      if (comentarios.length > 200) {
        comentarios = comentarios.slice(0, 200);
      }

      guardarInventario();
      guardarComentarios();
      renderTabla();
      renderComentarios();

      // No borramos nombre/marca/talla para poder seguir retirando parecido
      cantidadInput.value = 1;
      comentarioInput.value = "";
    });

    // -----------------------------
    // Botones de la tabla (editar, eliminar, +/-)
    // -----------------------------
    const tbody = document.querySelector("#tablaInventario tbody");

    tbody.addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if (!btn) return;

      const action = btn.dataset.action;
      const tr = btn.closest("tr");
      const id = tr ? tr.dataset.id : null;
      if (!id) return;

      const item = inventario.find((i) => String(i.id) === String(id));
      if (!item) return;

      if (action === "increase") {
        item.cantidad++;
      } else if (action === "decrease") {
        if (item.cantidad > 0) {
          item.cantidad--;
        }
      } else if (action === "edit") {
        const nuevoNombre = prompt("Nuevo nombre del 칤tem:", item.nombre);
        if (nuevoNombre !== null && nuevoNombre.trim() !== "") {
          item.nombre = nuevoNombre.trim();
        }

        const nuevaMarca = prompt("Nueva marca:", item.marca || "");
        if (nuevaMarca !== null) {
          item.marca = nuevaMarca.trim();
        }

        const nuevaTalla = prompt("Nueva talla:", item.talla || "");
        if (nuevaTalla !== null) {
          item.talla = nuevaTalla.trim();
        }

        const nuevaCantidadStr = prompt(
          "Nueva cantidad:",
          String(item.cantidad)
        );
        if (
          nuevaCantidadStr !== null &&
          nuevaCantidadStr.trim() !== ""
        ) {
          const nuevaCantidad = parseInt(nuevaCantidadStr, 10);
          if (!isNaN(nuevaCantidad) && nuevaCantidad >= 0) {
            item.cantidad = nuevaCantidad;
          } else {
            alert("Cantidad no v치lida. Se mantiene la anterior.");
          }
        }
      } else if (action === "delete") {
        if (confirm("쯉eguro que quieres eliminar este 칤tem?")) {
          inventario = inventario.filter((i) => String(i.id) !== String(id));
        }
      }

      guardarInventario();
      renderTabla();
    });

    // -----------------------------
    // Importar desde Excel
    // -----------------------------
    const excelInput = document.getElementById("excelFile");

    excelInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (evt) {
        try {
          const data = new Uint8Array(evt.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const firstSheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[firstSheetName];

          const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

          if (!rows || rows.length < 2) {
            alert("El archivo parece estar vac칤o.");
            return;
          }

          const headers = rows[0].map((h) =>
            (h || "").toString().toLowerCase().trim()
          );
          const idxNombre = headers.indexOf("nombre");
          const idxMarca = headers.indexOf("marca");
          const idxTalla = headers.indexOf("talla");
          const idxCantidad = headers.indexOf("cantidad");

          if (idxNombre === -1 || idxCantidad === -1) {
            alert(
              'La primera fila debe tener al menos las columnas "Nombre" y "Cantidad". Puedes agregar tambi칠n "Marca" y "Talla".'
            );
            return;
          }

          for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            if (!row || row.length === 0) continue;

            const nombre = row[idxNombre];
            const cantidadCruda = row[idxCantidad];

            if (!nombre) continue;

            const nombreStr = nombre.toString().trim();
            if (!nombreStr) continue;

            const marcaStr =
              idxMarca !== -1 && row[idxMarca] != null
                ? row[idxMarca].toString().trim()
                : "";
            const tallaStr =
              idxTalla !== -1 && row[idxTalla] != null
                ? row[idxTalla].toString().trim()
                : "";

            const cantidad = parseInt(cantidadCruda, 10) || 0;
            const existente = buscarItem(nombreStr, marcaStr, tallaStr);

            if (existente) {
              existente.cantidad += cantidad;
            } else {
              inventario.push({
                id: Date.now() + i + Math.random(),
                nombre: nombreStr,
                marca: marcaStr,
                talla: tallaStr,
                cantidad,
              });
            }
          }

          guardarInventario();
          renderTabla();
          alert("Importaci칩n desde Excel completada 游떀");
        } catch (err) {
          console.error(err);
          alert("Ocurri칩 un problema al leer el Excel.");
        }
      };

      reader.readAsArrayBuffer(file);
    });

    // -----------------------------
    // Inicio
    // -----------------------------
    cargarDesdeStorage();
    renderTabla();
    renderComentarios();
  </script>
</body>
</html>
